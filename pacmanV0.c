#include <stdio.h>
#include <curses.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <time.h>

//macro keypad
#define SU 65
#define GIU 66
#define DESTRA 67
#define SINISTRA 68
#define STOP 0 //non è del keypad ma fa parte del movimento
//macro menu
#define NEWGAME 0
#define EXIT 1
#define SUGA 2
//macro di gioco
#define LEVELS 1

//stampa del menu
void printNewGame();
void printExit();
void printSUGA();

//gioco
int mainMenu();
int levelsMenu(); //TODO
void gameController(int pipe, int level);
void pacman(int pipe);

//stampa del gioco
void printCampo(int level); //TODO poi da aggiornare con i prossimi livelli
void printPacMan(int x, int y, int direction);
void printDati();

/** PROBLEMONE, COME FACCIAMO QUANDO I FANTASMI PASSANO SOPRA I PALLINI? **/
//TODO void printPacMan(coordinate vecchie, direzione); //da passare come parametro le vecchie coordinate e la direzione così sappiamo dove dobbiamo cancellare
//TODO void printGhost(coordinate vecchie, direzione e tipo) //vecchie coordinate e la direzione così sappiamo dove dobbiamo cancellare

int main() {
    int menu, level;
    int pipePacMan[2];
    pid_t pid_PacMan;
    
    initscr(); 					    /* inizializzazione dello schermo */
    noecho();					    /* i caratteri corrispondenti ai tasti premuti non saranno visualizzati sullo schermo del terminale */
    srand(time((time_t*)NULL)); 	/* inizializziamo il generatore di numeri random */
    curs_set(0); 				    /* nasconde il cursore */

    start_color();
    init_pair(1, COLOR_WHITE, COLOR_BLACK);
    init_pair(2, COLOR_YELLOW, COLOR_YELLOW);
    init_pair(3, COLOR_BLACK, COLOR_BLACK);

    menu = mainMenu();

    if(menu != EXIT) {
        if(pipe(pipePacMan) == -1) {
        perror("Errore nella creazione della pipe di PacMan!");
        _exit(1);
        }

        switch (pid_PacMan = fork()) {
            case -1:
                perror("Errore nell'esecuzione della fork di PacMan");
                break;
            case 0: //figlio -> pacman
                close(pipePacMan[0]);
                pacman(pipePacMan[1]);
                break;
            default: //padre -> gioco
                close(pipePacMan[1]);
                gameController(pipePacMan[0], level);
                break;
        }
    }
    

    refresh();

    while (getch()!='\n');//Aspetto che l'utente prema invio
        endwin();//Ripristino il normale funzionamento del terminale

    return 0;
}

int mainMenu() {
    int menu = 0;
    char selMenu;

    do {
        
        switch(menu) {
            case NEWGAME:
                printNewGame();
                break;
            case EXIT:
                printExit();
                break;
            case SUGA:
                printSUGA();
                break;
        }

        selMenu = getch();
        switch (selMenu) {
            case GIU:
                menu++;
                break;
            case SU:
                menu--;
                break;
        }
        menu = menu%3;

    } while(selMenu != '\n');
}

int levelsMenu() {
  //TODO  
}

void gameController(int pipe, int level) {
    printCampo(level);
}

void pacman(int pipe) {
    int currDir = STOP;
    int nextDir = STOP;

    do {

    } while();

    printPacMan(29,45,0);
}

_Bool pacmanMv(int x, int y, int dir) {
    switch (dir) {
        case SU:
            if(mvinch(y-1,x) == '#' && mvinch(y-1,x+1) == '#' && mvinch(y-1,x+2) == '#')
                return false;
            break;
        case GIU:
            if(mvinch(y+4,x) == '#' && mvinch(y+4,x+1) == '#' && mvinch(y+4,x+2) == '#')
                return false;
            break;
        case DESTRA:
            if(mvinch(y,x+4) == '#' && mvinch(y+1,x+4) == '#' && mvinch(y+2,x+4) == '#')
                return false;
            break;
        case SINISTRA:
            if(mvinch(y,x-1) == '#' && mvinch(y+1,x-1) == '#' && mvinch(y+2,x-1) == '#')
                return false;
            break;
    }
    return true;
}

void printNewGame() {

    char newGame[60][152] = {"##==================================================================================================================================================##\n",
    "||                                                                                                                                                  ||\n",
    "||                                    ===========================================================================                                   ||\n",
    "||                                    =       ======  =======     ==============  =====  =====  =====  =======  =                                   ||\n",
    "||                                    =  ====  ====    =====  ===  =============   ===   ====    ====   ======  =                                   ||\n",
    "||                                    =  ====  ===  ==  ===  ===================  =   =  ===  ==  ===    =====  =                                   ||\n",
    "||                                    =  ====  ==  ====  ==  ===================  == ==  ==  ====  ==  ==  ===  =                                   ||\n",
    "||                                    =       ===  ====  ==  ========         ==  =====  ==  ====  ==  ===  ==  =                                   ||\n",
    "||                                    =  ========        ==  ===================  =====  ==        ==  ====  =  =                                   ||\n",
    "||                                    =  ========  ====  ==  ===================  =====  ==  ====  ==  =====    =                                   ||\n",
    "||                                    =  ========  ====  ===  ===  =============  =====  ==  ====  ==  ======   =                                   ||\n",
    "||                                    =  ========  ====  ====     ==============  =====  ==  ====  ==  =======  =                                   ||\n",
    "||                                    ===========================================================================                                   ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                ##================##                                                              ||\n",
    "||                                                                || NUOVA  PARTITA ||                                                              ||\n",
    "||                                                                ##================##                                                              ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                        ESCI                                                                      ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                        SUGA                                                                      ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for(int i=0; i<=49; i++)
        mvprintw(i, 0, "%s", newGame[i]);

}

void printExit() {

    char newGame[60][152] = {"##==================================================================================================================================================##\n",
    "||                                                                                                                                                  ||\n",
    "||                                    ===========================================================================                                   ||\n",
    "||                                    =       ======  =======     ==============  =====  =====  =====  =======  =                                   ||\n",
    "||                                    =  ====  ====    =====  ===  =============   ===   ====    ====   ======  =                                   ||\n",
    "||                                    =  ====  ===  ==  ===  ===================  =   =  ===  ==  ===    =====  =                                   ||\n",
    "||                                    =  ====  ==  ====  ==  ===================  == ==  ==  ====  ==  ==  ===  =                                   ||\n",
    "||                                    =       ===  ====  ==  ========         ==  =====  ==  ====  ==  ===  ==  =                                   ||\n",
    "||                                    =  ========        ==  ===================  =====  ==        ==  ====  =  =                                   ||\n",
    "||                                    =  ========  ====  ==  ===================  =====  ==  ====  ==  =====    =                                   ||\n",
    "||                                    =  ========  ====  ===  ===  =============  =====  ==  ====  ==  ======   =                                   ||\n",
    "||                                    =  ========  ====  ====     ==============  =====  ==  ====  ==  =======  =                                   ||\n",
    "||                                    ===========================================================================                                   ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                   NUOVA  PARTITA                                                                 ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                ##================##                                                              ||\n",
    "||                                                                ||      ESCI      ||                                                              ||\n",
    "||                                                                ##================##                                                              ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                        SUGA                                                                      ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for(int i=0; i<=49; i++)
        mvprintw(i, 0, "%s", newGame[i]);

}

void printSUGA() {

    char newGame[60][152] = {"##==================================================================================================================================================##\n",
    "||                                                                                                                                                  ||\n",
    "||                                    ===========================================================================                                   ||\n",
    "||                                    =       ======  =======     ==============  =====  =====  =====  =======  =                                   ||\n",
    "||                                    =  ====  ====    =====  ===  =============   ===   ====    ====   ======  =                                   ||\n",
    "||                                    =  ====  ===  ==  ===  ===================  =   =  ===  ==  ===    =====  =                                   ||\n",
    "||                                    =  ====  ==  ====  ==  ===================  == ==  ==  ====  ==  ==  ===  =                                   ||\n",
    "||                                    =       ===  ====  ==  ========         ==  =====  ==  ====  ==  ===  ==  =                                   ||\n",
    "||                                    =  ========        ==  ===================  =====  ==        ==  ====  =  =                                   ||\n",
    "||                                    =  ========  ====  ==  ===================  =====  ==  ====  ==  =====    =                                   ||\n",
    "||                                    =  ========  ====  ===  ===  =============  =====  ==  ====  ==  ======   =                                   ||\n",
    "||                                    =  ========  ====  ====     ==============  =====  ==  ====  ==  =======  =                                   ||\n",
    "||                                    ===========================================================================                                   ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                   NUOVA  PARTITA                                                                 ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                        ESCI                                                                      ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                ##================##                                                              ||\n",
    "||                                                                ||      SUGA      ||                                                              ||\n",
    "||                                                                ##================##                                                              ||\n",
    "||                                                              super user general access                                                           ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "||                                                                                                                                                  ||\n",
    "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for(int i=0; i<=49; i++)
        mvprintw(i, 0, "%s", newGame[i]);

}

void printCampo(int level){
    char Campo[60][152]={"##==================================================================================================================================================##\n",
    "||                                                                                                                                                  ||\n",
    "||                                      #######################################################################                                     ||\n",
    "||                                      #                              #########                              #                                     ||\n",
    "||                                      # .  .  .  .   .  .  .  . .  . ######### .  . .  .  .  .   .  .  .  . #                                     ||\n",
    "||         LEVEL:                       #                              #########                              #             LIVEs:                  ||\n",
    "||         SCORE:                       #   ##########   ###########   #########   ###########   ##########   #             TIME:                   ||\n",
    "||                                      # . ########## . ########### . ######### . ########### . ########## . #             FRUITs:                 ||\n",
    "||                                      #   ##########   ###########   #########   ###########   ##########   #             KILLs:                  ||\n",
    "||                                      #   ##########   ###########   #########   ###########   ##########   #                                     ||\n",
    "||         HIGHSCORES:                  # . ########## . ########### . ######### . ########### . ########## . #                                     ||\n",
    "||         1.                           #   ##########   ###########   #########   ###########   ##########   #                                     ||\n",
    "||         2.                           #                                                                     #                                     ||\n",
    "||         3.                           # .  .  .  .   .  .  .  . .  .  .  .  .  .  . .  .  .  .   .  .  .  . #                                     ||\n",
    "||                                      #                                                                     #                                     ||\n",
    "||                                      #   ##########   ######   ###################   ######   ##########   #                                     ||\n",
    "||                                      # . ########## . ###### . ################### . ###### . ########## . #                                     ||\n",
    "||                                      #   ##########   ######   ###################   ######   ##########   #                                     ||\n",
    "||                                      #                ######        #########        ######                #                                     ||\n",
    "||                                      # .  .  .   .  . ###### .    . ######### .    . ###### .  .   .  .  . #                                     ||\n",
    "||                                      #                ######        #########        ######                #                                     ||\n",
    "||                                      ##############   ###########   #########   ###########   ##############                                     ||\n",
    "||                                      ############## . ########### . ######### . ########### . ##############                                     ||\n",
    "||                                      ##############   ###########   #########   ###########   ##############                                     ||\n",
    "||                                      ##############   ######                         ######   ##############                                     ||\n",
    "||                                      ############## . ###### .  .  .  .   .  .  .  . ###### . ##############                                     ||\n",
    "||                                      ##############   ######                         ######   ##############                                     ||\n",
    "||                                      ##############   ######   #######+   +#######   ######   ##############                                     ||\n",
    "||                                      ############## . ###### . #                 # . ###### . ##############                                     ||\n",
    "||                                                                +                 +                                                               ||\n",
    "||                                                     .  .  .  .                     .  .  .  .                                                    ||\n",
    "||                                                                +                 +                                                               ||\n",
    "||                                      ############## . ###### . #                 # . ###### . ##############                                     ||\n",
    "||                                      ##############   ######   #######+   +#######   ######   ##############                                     ||\n",
    "||                                      ##############   ######                         ######   ##############                                     ||\n",
    "||                                      ############## . ###### .  .  .  .   .  .  .  . ###### . ##############                                     ||\n",
    "||                                      ##############   ######                         ######   ##############                                     ||\n",
    "||                                      ##############   ######   ###################   ######   ##############                                     ||\n",
    "||                                      #                               #######                               #                                     ||\n",
    "||                                      # .  .  .  .   .  .  .  .  .  . ####### .  .  .  .  .  .   .  .  .  . #                                     ||\n",
    "||                                      #                               #######                               #                                     ||\n",
    "||                                      #   ##########   ############   #######   ############   ##########   #                                     ||\n",
    "||                                      # . ########## . ############ . ####### . ############ . ########## . #                                     ||\n",
    "||                                      #   ##########   ############   #######   ############   ##########   #                                     ||\n",
    "||                                      #          ###                                           ###          #                                     ||\n",
    "||                                      # .  .   . ### .  .  .  .  .  .  .   .  .  .  .  .  .  . ### .   .  . #                                     ||\n",
    "||                                      #          ###                                           ###          #                                     ||\n",
    "||                                      ########   ###   ######   ###################   ######   ###   ########                                     ||\n",
    "||                                      ######## . ### . ###### . ################### . ###### . ### . ########                                     ||\n",
    "||                                      ########   ###   ######   ###################   ######   ###   ########                                     ||\n",
    "||                                      #                ######         #######         ######                #                                     ||\n",
    "||                                      # .  .  .   .  . ###### .  .  . ####### .  .  . ###### .  .   .  .  . #                                     ||\n",
    "||                                      #                ######         #######         ######                #                                     ||\n",
    "||                                      # . ######################### . ####### . ######################### . #                                     ||\n",
    "||                                      #                                                                     #                                     ||\n",
    "||                                      # .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . #                                     ||\n",
    "||                                      #                                                                     #                                     ||\n",
    "||                                      #######################################################################                                     ||\n",
    "||                                                                                                                                                  ||\n",
    "##==================================================================================================================================================##"};
    
    attron(COLOR_PAIR(1));
    for (int i=0; i<=59; i++)
        mvprintw(i,0,"%s", Campo[i]);
}

void printPacMan(int x, int y, int direction) {
    char pacmanSU[3][3] = {{' ','1',' '},{'1',' ','1'},{'1','1','1'}};
    char pacmanGIU[3][3] = {{'1','1','1'},{'1',' ','1'},{' ','1',' '}};
    char pacmanDESTRA[3][3] = {{'1','1',' '},{'1',' ','1'},{'1','1',' '}};
    char pacmanSINISTRA[3][3] = {{' ','1','1'},{'1',' ','1'},{' ','1','1'}};

    switch (direction) {
        case SU:
            for(int i=0; i<=2; i++) {
                for(int j=0; j<=2; j++) {
                    if(pacmanSU[j][i] == '1') {
                        attron(COLOR_PAIR(2));
                        mvaddch(x+i, y+j, pacmanSU[i][j]);
                    } else {
                        attron(COLOR_PAIR(3));
                        mvaddch(x+i, y+j, pacmanSU[i][j]);
                    }
                }
            }
            break;
        case GIU:
            for(int i=0; i<=2; i++) {
                for(int j=0; j<=2; j++) {
                    if(pacmanGIU[j][i] == '1') {
                        attron(COLOR_PAIR(2));
                        mvaddch(x+i, y+j, pacmanGIU[i][j]);
                    } else {
                        attron(COLOR_PAIR(3));
                        mvaddch(x+i, y+j, pacmanGIU[i][j]);
                    }
                }
            }
            break;
        case DESTRA:
            for(int i=0; i<=2; i++) {
                for(int j=0; j<=2; j++) {
                    if(pacmanDESTRA[j][i] == '1') {
                        attron(COLOR_PAIR(2));
                        mvaddch(x+i, y+j, pacmanDESTRA[i][j]);
                    } else {
                        attron(COLOR_PAIR(3));
                        mvaddch(x+i, y+j, pacmanDESTRA[i][j]);
                    }
                }
            }
            break;
        case SINISTRA:
            for(int i=0; i<=2; i++) {
                for(int j=0; j<=2; j++) {
                    if(pacmanSINISTRA[j][i] == '1') {
                        attron(COLOR_PAIR(2));
                        mvaddch(x+i, y+j, pacmanSINISTRA[i][j]);
                    } else {
                        attron(COLOR_PAIR(3));
                        mvaddch(x+i, y+j, pacmanSINISTRA[i][j]);
                    }
                }
            }
            break;
        default:
            for(int i=0; i<=2; i++) {
                for(int j=0; j<=2; j++) {
                    if(pacmanSU[i][j] == '1') {
                        attron(COLOR_PAIR(2));
                        mvaddch(x+i, y+j, pacmanSU[i][j]);
                    } else {
                        attron(COLOR_PAIR(3));
                        mvaddch(x+i, y+j, pacmanSU[i][j]);
                    }
                }
            }
            break;
    }

}

void clearPacMan(int x, int y) {
    attron(COLOR_PAIR(0));
    for(int i=0; i<3; i++)
        for(int j=0; j<0; j++)
            mvaddch(x+i, y+j, ' ');
}

void printDati(){
    mvprintw(5, 19, "%s", "1"); //Livello
    mvprintw(6, 19, "%s", "000"); //Score
    mvprintw(5, 133, "%s", "@ @ @"); //Vite
    mvprintw(6, 133, "%s", "00:00");//Tempo
    mvprintw(7, 133, "%s", "0");//Frutta
    mvprintw(8, 133, "%s", "0");//Kills
    
}













