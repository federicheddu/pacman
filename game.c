#include "game.h"

/** --- STAMPA DEL MENU ------------------------------------------------------------- **/

//gestione del menu
int mainMenu() {
    int menu = 0;
    char selMenu;

    do {

        switch(menu) {
            case NEWGAME:
                printNewGame();
                break;
            case EXIT:
                printExit();
                break;
            case SUGA:
                printSUGA();
                break;
        }

        selMenu = getch();
        switch (selMenu) {
            case GIU:
                menu++;
                break;
            case SU:
                menu--;
                break;
        }
        menu = menu%3;

    } while(selMenu != '\n');
    return menu;
}

//stampa della schermata Nuova Partita
void printNewGame() {

    char newGame[60][152] = {"##==================================================================================================================================================##\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                    ===========================================================================                                   ||\n",
                             "||                                    =       ======  =======     ==============  =====  =====  =====  =======  =                                   ||\n",
                             "||                                    =  ====  ====    =====  ===  =============   ===   ====    ====   ======  =                                   ||\n",
                             "||                                    =  ====  ===  ==  ===  ===================  =   =  ===  ==  ===    =====  =                                   ||\n",
                             "||                                    =  ====  ==  ====  ==  ===================  == ==  ==  ====  ==  ==  ===  =                                   ||\n",
                             "||                                    =       ===  ====  ==  ========         ==  =====  ==  ====  ==  ===  ==  =                                   ||\n",
                             "||                                    =  ========        ==  ===================  =====  ==        ==  ====  =  =                                   ||\n",
                             "||                                    =  ========  ====  ==  ===================  =====  ==  ====  ==  =====    =                                   ||\n",
                             "||                                    =  ========  ====  ===  ===  =============  =====  ==  ====  ==  ======   =                                   ||\n",
                             "||                                    =  ========  ====  ====     ==============  =====  ==  ====  ==  =======  =                                   ||\n",
                             "||                                    ===========================================================================                                   ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                ##================##                                                              ||\n",
                             "||                                                                || NUOVA  PARTITA ||                                                              ||\n",
                             "||                                                                ##================##                                                              ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                        ESCI                                                                      ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                        SUGA                                                                      ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for(int i=0; i<=49; i++)
        mvprintw(i, 0, "%s", newGame[i]);

}

//stampa della schermata Esci
void printExit() {

    char newGame[60][152] = {"##==================================================================================================================================================##\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                    ===========================================================================                                   ||\n",
                             "||                                    =       ======  =======     ==============  =====  =====  =====  =======  =                                   ||\n",
                             "||                                    =  ====  ====    =====  ===  =============   ===   ====    ====   ======  =                                   ||\n",
                             "||                                    =  ====  ===  ==  ===  ===================  =   =  ===  ==  ===    =====  =                                   ||\n",
                             "||                                    =  ====  ==  ====  ==  ===================  == ==  ==  ====  ==  ==  ===  =                                   ||\n",
                             "||                                    =       ===  ====  ==  ========         ==  =====  ==  ====  ==  ===  ==  =                                   ||\n",
                             "||                                    =  ========        ==  ===================  =====  ==        ==  ====  =  =                                   ||\n",
                             "||                                    =  ========  ====  ==  ===================  =====  ==  ====  ==  =====    =                                   ||\n",
                             "||                                    =  ========  ====  ===  ===  =============  =====  ==  ====  ==  ======   =                                   ||\n",
                             "||                                    =  ========  ====  ====     ==============  =====  ==  ====  ==  =======  =                                   ||\n",
                             "||                                    ===========================================================================                                   ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                   NUOVA  PARTITA                                                                 ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                ##================##                                                              ||\n",
                             "||                                                                ||      ESCI      ||                                                              ||\n",
                             "||                                                                ##================##                                                              ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                        SUGA                                                                      ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for(int i=0; i<=49; i++)
        mvprintw(i, 0, "%s", newGame[i]);

}

//Stampa della schermata Selezione Progetto
void printSUGA() {

    char newGame[60][152] = {"##==================================================================================================================================================##\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                    ===========================================================================                                   ||\n",
                             "||                                    =       ======  =======     ==============  =====  =====  =====  =======  =                                   ||\n",
                             "||                                    =  ====  ====    =====  ===  =============   ===   ====    ====   ======  =                                   ||\n",
                             "||                                    =  ====  ===  ==  ===  ===================  =   =  ===  ==  ===    =====  =                                   ||\n",
                             "||                                    =  ====  ==  ====  ==  ===================  == ==  ==  ====  ==  ==  ===  =                                   ||\n",
                             "||                                    =       ===  ====  ==  ========         ==  =====  ==  ====  ==  ===  ==  =                                   ||\n",
                             "||                                    =  ========        ==  ===================  =====  ==        ==  ====  =  =                                   ||\n",
                             "||                                    =  ========  ====  ==  ===================  =====  ==  ====  ==  =====    =                                   ||\n",
                             "||                                    =  ========  ====  ===  ===  =============  =====  ==  ====  ==  ======   =                                   ||\n",
                             "||                                    =  ========  ====  ====     ==============  =====  ==  ====  ==  =======  =                                   ||\n",
                             "||                                    ===========================================================================                                   ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                   NUOVA  PARTITA                                                                 ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                        ESCI                                                                      ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                ##================##                                                              ||\n",
                             "||                                                                ||      SUGA      ||                                                              ||\n",
                             "||                                                                ##================##                                                              ||\n",
                             "||                                                              super user general access                                                           ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "||                                                                                                                                                  ||\n",
                             "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for(int i=0; i<=49; i++)
        mvprintw(i, 0, "%s", newGame[i]);

}


/** --- STAMPA DEL GIOCO ------------------------------------------------------------ **/

//stampa del gioco
void printCampo(int level){
  char Campo[60][152]={"##==================================================================================================================================================##\n",
                       "||                                                                                                                                                  ||\n",
                       "||                                      #######################################################################                                     ||\n",
                       "||                                      #                              #########                              #                                     ||\n",
                       "||                                      # .  .  .  .   .  .  .  . .  . ######### .  . .  .  .  .   .  .  .  . #                                     ||\n",
                       "||         LEVEL:                       #                              #########                              #             LIVEs:                  ||\n",
                       "||         SCORE:                       #   ##########   ###########   #########   ###########   ##########   #             TIME:                   ||\n",
                       "||                                      # . ########## . ########### . ######### . ########### . ########## . #             FRUITs:                 ||\n",
                       "||                                      #   ##########   ###########   #########   ###########   ##########   #             KILLs:                  ||\n",
                       "||                                      #   ##########   ###########   #########   ###########   ##########   #                                     ||\n",
                       "||         HIGHSCORES:                  # . ########## . ########### . ######### . ########### . ########## . #                                     ||\n",
                       "||         1.                           #   ##########   ###########   #########   ###########   ##########   #                                     ||\n",
                       "||         2.                           #                                                                     #                                     ||\n",
                       "||         3.                           # .  .  .  .   .  .  .  . .  .  .  .  .  .  . .  .  .  .   .  .  .  . #                                     ||\n",
                       "||                                      #                                                                     #                                     ||\n",
                       "||                                      #   ##########   ######   ###################   ######   ##########   #                                     ||\n",
                       "||                                      # . ########## . ###### . ################### . ###### . ########## . #                                     ||\n",
                       "||                                      #   ##########   ######   ###################   ######   ##########   #                                     ||\n",
                       "||                                      #                ######        #########        ######                #                                     ||\n",
                       "||                                      # .  .  .   .  . ###### .    . ######### .    . ###### .  .   .  .  . #                                     ||\n",
                       "||                                      #                ######        #########        ######                #                                     ||\n",
                       "||                                      ##############   ###########   #########   ###########   ##############                                     ||\n",
                       "||                                      ############## . ########### . ######### . ########### . ##############                                     ||\n",
                       "||                                      ##############   ###########   #########   ###########   ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ############## . ###### .  .  .  .   .  .  .  . ###### . ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ##############   ######   #######+   +#######   ######   ##############                                     ||\n",
                       "||                                      ############## . ###### . #                 # . ###### . ##############                                     ||\n",
                       "||                                                                +                 +                                                               ||\n",
                       "||                                                     .  .  .  .                     .  .  .  .                                                    ||\n",
                       "||                                                                +                 +                                                               ||\n",
                       "||                                      ############## . ###### . #                 # . ###### . ##############                                     ||\n",
                       "||                                      ##############   ######   #######+   +#######   ######   ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ############## . ###### .  .  .  .   .  .  .  . ###### . ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ##############   ######   ###################   ######   ##############                                     ||\n",
                       "||                                      #                               #######                               #                                     ||\n",
                       "||                                      # .  .  .  .   .  .  .  .  .  . ####### .  .  .  .  .  .   .  .  .  . #                                     ||\n",
                       "||                                      #                               #######                               #                                     ||\n",
                       "||                                      #   ##########   ############   #######   ############   ##########   #                                     ||\n",
                       "||                                      # . ########## . ############ . ####### . ############ . ########## . #                                     ||\n",
                       "||                                      #   ##########   ############   #######   ############   ##########   #                                     ||\n",
                       "||                                      #          ###                                           ###          #                                     ||\n",
                       "||                                      # .  .   . ### .  .  .  .  .  .  .   .  .  .  .  .  .  . ### .   .  . #                                     ||\n",
                       "||                                      #          ###                                           ###          #                                     ||\n",
                       "||                                      ########   ###   ######   ###################   ######   ###   ########                                     ||\n",
                       "||                                      ######## . ### . ###### . ################### . ###### . ### . ########                                     ||\n",
                       "||                                      ########   ###   ######   ###################   ######   ###   ########                                     ||\n",
                       "||                                      #                ######         #######         ######                #                                     ||\n",
                       "||                                      # .  .  .   .  . ###### .  .  . ####### .  .  . ###### .  .   .  .  . #                                     ||\n",
                       "||                                      #                ######         #######         ######                #                                     ||\n",
                       "||                                      # . ######################### . ####### . ######################### . #                                     ||\n",
                       "||                                      #                                                                     #                                     ||\n",
                       "||                                      # .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . #                                     ||\n",
                       "||                                      #                                                                     #                                     ||\n",
                       "||                                      #######################################################################                                     ||\n",
                       "||                                                                                                                                                  ||\n",
                       "##==================================================================================================================================================##"};

    attron(COLOR_PAIR(1));
    for (int i=0; i<=59; i++){
        for(int j=0; j<=151; j++){
            if(Campo[i][j] == '#' && (j> 2 && j< 145)){
                attron(COLOR_PAIR(4));
                mvprintw(i,j, "%c", Campo[i][j]);
                attroff(COLOR_PAIR(4));
            }else{
                mvprintw(i,j,"%c", Campo[i][j]);
            }
        }
    }
}

void printStats(int livello, int score){
    //stampo livello
    mvprintw(5, 18, "%d", livello);
    //stampo score
    mvprintw(6, 18, "%d", score);
}

void printDot(int num, int pallini[][num]){
    for(int i; i<NUM_PALLINI; i++){
        if(pallini[i][2]==0){
            mvprintw(pallini[i][0], pallini[i][1], "%c", '.');
        }
    }
}

void printEntity(Pos entita, pthread_mutex_t *mutex) {

    switch (entita.entita) {
        case BULLET:
            

            if(entita.dir == SINISTRA){
            attron(COLOR_PAIR(7));
            mvprintw(entita.y,entita.x,"o");
            attroff(COLOR_PAIR(7));
            }else
            {
            attron(COLOR_PAIR(6));
            mvprintw(entita.y,entita.x,"o");
            attroff(COLOR_PAIR(6));
            }
            


            
            break;
        case PACMAN:
            attron(COLOR_PAIR(5));
            mvprintw(entita.y,entita.x, "%s","P M"); //1° riga
            mvprintw(entita.y+1,entita.x, "%s"," A "); //2° riga
            mvprintw(entita.y+2,entita.x, "%s","N C"); //3° riga
            attroff(COLOR_PAIR(5));
            break;
        case BLINKY:
            attron(COLOR_PAIR(3));
            //1° riga
            mvprintw(entita.y,entita.x, "%s","B@N");
            //2° riga
            mvprintw(entita.y+1,entita.x, "%s","L K");
            //3° riga
            mvprintw(entita.y+2,entita.x, "%s","I@Y");
            attroff(COLOR_PAIR(3));
            break;
        case PINKY:
            break;
        case CLYDE:
            break;
        case INKY:
            break;
        case FUNKY:
            break;
        case GLITCHY:
            break;
    }
}

void clearEntity(Pos entita, pthread_mutex_t *mutex, int num, int pallini[][num]) {

    switch(entita.dir) {
      case SU:
        mvprintw(entita.y+3,entita.x, "%s","   ");
        if(entita.entita>PACMAN)
            for(int i=0; i<NUM_PALLINI; i++)
                if(entita.y+3 == pallini[i][0] && entita.x+1 == pallini[i][1] && pallini[i][2] == 0)
                    mvprintw(entita.y+3,entita.x+1, "%c",'.');
        break;

      case GIU:
        mvprintw(entita.y-1,entita.x, "%s", "   ");
        if(entita.entita>PACMAN)
            for(int i=0; i<NUM_PALLINI; i++)
                if(entita.y-1 == pallini[i][0] && entita.x+1 == pallini[i][1] && pallini[i][2] == 0)
                    mvprintw(entita.y-1,entita.x+1, "%c", '.');
        break;

      case SINISTRA:
        mvprintw(entita.y,entita.x+3, "%c", ' ');
        if(entita.entita != BULLET) {
            mvprintw(entita.y+1,entita.x+3, "%c", ' ');
            mvprintw(entita.y+2,entita.x+3, "%c", ' ');
        }
        

        if(entita.entita>PACMAN)
            for(int i=0; i<NUM_PALLINI; i++)
                if(entita.y+1 == pallini[i][0] && entita.x+3 == pallini[i][1] && pallini[i][2] == 0)
                    mvprintw(entita.y+1,entita.x+3, "%c",'.');

        if(entita.x == 108) {
            mvprintw(entita.y,40, "%s","   ");
            mvprintw(entita.y+1,40, "%s","   ");
            mvprintw(entita.y+2,40, "%s","   ");
        }
        break;

      case DESTRA:
        mvprintw(entita.y,entita.x-1, "%c",' ');
        if(entita.entita != BULLET) {
            mvprintw(entita.y+1,entita.x-1, "%c",' ');
            mvprintw(entita.y+2,entita.x-1, "%c",' ');
        }
        
        if(entita.entita>PACMAN)
            for(int i=0; i<NUM_PALLINI; i++)
                if(entita.y+1 == pallini[i][0] && entita.x-1 == pallini[i][1] && pallini[i][2] == 0)
                    mvprintw(entita.y+1,entita.x-1, "%c",'.');

        if(entita.x == 40) {
            mvprintw(entita.y,108, "%s","   ");
            mvprintw(entita.y+1,108, "%s","   ");
            mvprintw(entita.y+2,108, "%s","   ");
        }
        break;
    }
}

/** --- INIZIALIZZAZIONE DATI ------------------------------------------------------- **/

//inizializzazione dei proiettili
void startBullet(int num, Pos proiettili[][num]) {
    for(int i=0; i<7; i++) {
        for (int j=0; j<4; j++) {
            proiettili[i][j].x = -1;
            proiettili[i][j].y = -1;
            proiettili[i][j].id = NULL;
            proiettili[i][j].sparo = false;
            proiettili[i][j].entita = BULLET;
            proiettili[i][j].dir = i+SHIFT_MOVIMENTO;
        }
    }
}

//inizializzazione dei personaggi
void startCharacter(Par personaggi[]) {
    for(int i=0; i<NUM_PERSONAGGI; i++) {
        personaggi[i].vite = 3;
        personaggi[i].colpiSubiti = 0;
    }
}

/** --- CONTROLLI DI GIOCO ---------------------------------------------------------- **/
_Bool canShoot(Pos proiettili[][MAX_PROIETTILI], Entity entita) {
    return !proiettili[entita][SU-SHIFT_MOVIMENTO].sparo && !proiettili[entita][GIU-SHIFT_MOVIMENTO].sparo && !proiettili[entita][DESTRA-SHIFT_MOVIMENTO].sparo && !proiettili[entita][SINISTRA-SHIFT_MOVIMENTO].sparo;
}

int checkScore(int x, int y, int num, int pallini[][num]){
    for (int i; i<NUM_PALLINI; i++){
        if(pallini[i][0] == y+1)
            if(pallini[i][1] == x+1)
                if(pallini[i][2] == 0){
                    pallini[i][2] = 1;
                    return 10;
                }
    }
    return 0;
}

_Bool bulletMv(int x, int y, char dir) {

    switch (dir) {
        case SU:
            if(scampo[y-1][x] == '#' )
                return false;
            break;
        case GIU:
            if(scampo[y+1][x] == '#' )
                return false;
            break;
        case DESTRA:
            if(scampo[y][x+1] == '#' )
                return false;
            break;
        case SINISTRA:
            if(scampo[y][x-1] == '#' )
                return false;
            break;
        default:
            return false;
    }
    return true;
}

/** --- ENTITÀ GENERALI ------------------------------------------------------------- **/
void * bullet(void * param) {
    PosStart *start = (PosStart*) param;
    Pos posIniziale = start -> posizione;
    Buffer* buffer = start -> buffer;

    Pos posBullet;
    posBullet.x = posIniziale.x;
    posBullet.y = posIniziale.y;
    posBullet.dir = posIniziale.dir;
    posBullet.sparo = true;
    posBullet.entita = BULLET;
    posBullet.id = pthread_self();

    //Movimento bullet
    while(bulletMv(posBullet.x, posBullet.y, posBullet.dir)) {
        switch (posBullet.dir) {
            case SU:
            posBullet.y -= 1;
            break;
        case GIU:
            posBullet.y += 1;
            break;
        case DESTRA:
            posBullet.x += 1;
            break;
        case SINISTRA:
            posBullet.x -= 1;
            break;
        }

        insertBuffer(buffer, mutexDati, posBullet);
        usleep(200000);
    }

    //PUNTO DI MORTEH
    switch (posBullet.dir) {
        case SU:
            posBullet.y -= 1;
            break;
        case GIU:
            posBullet.y += 1;
            break;
        case DESTRA:
            posBullet.x += 1;
            break;
        case SINISTRA:
            posBullet.x -= 1;
            break;
    }
    posBullet.sparo = false;
    insertBuffer(buffer,mutexDati,posBullet);
    
}

/** --- GIOCO ----------------------------------------------------------------------- **/
void gameController(int livello, Buffer *buffer){

    int score = 0;

    int ciclo = 0;
    clock_t start, end;
    double deltaTime;

    Pos entita;
    PosStart posPartenza;
    posPartenza.buffer = buffer;

    Par personaggi[NUM_PERSONAGGI];
    startCharacter(personaggi);
    Pos proiettili[NUM_PERSONAGGI][MAX_PROIETTILI];
    startBullet(MAX_PROIETTILI, proiettili);

    int pallini[210][3]={{4, 42, 0},{4, 45, 0},{4, 48, 0},{4, 51, 0},
        {4, 55, 0},{4, 58, 0},{4, 61, 0},{4, 64, 0},{4, 66, 0},{4, 69, 0},
        {4, 81, 0},{4, 84, 0},{4, 86, 0},{4, 89, 0},{4, 92, 0},{4, 95, 0},
        {4, 99, 0},{4, 102, 0},{4, 105, 0},{4, 108, 0},{7, 42, 0},{7, 55, 0},
        {7, 69, 0},{7, 81, 0},{7, 95, 0},{7, 108, 0},{10, 42, 0},{10, 55, 0},
        {10, 69, 0},{10, 81, 0},{10, 95, 0},{10, 108, 0},{13, 42, 0},{13, 45, 0},
        {13, 48, 0},{13, 51, 0},{13, 55, 0},{13, 58, 0},{13, 61, 0},{13, 64, 0},
        {13, 66, 0},{13, 69, 0},{13, 72, 0},{13, 75, 0},{13, 78, 0},{13, 81, 0},
        {13, 84, 0},{13, 86, 0},{13, 89, 0},{13, 92, 0},{13, 95, 0},{13, 99, 0},
        {13, 102, 0},{13, 105, 0},{13, 108, 0},{16, 42, 0},{16, 55, 0},{16, 64, 0},
        {16, 86, 0},{16, 95, 0},{16, 108, 0},{19, 42, 0},{19, 45, 0},{19, 48, 0},
        {19, 52, 0},{19, 55, 0},{19, 64, 0},{19, 69, 0},{19, 81, 0},{19, 86, 0},
        {19, 95, 0},{19, 98, 0},{19, 102, 0},{19, 105, 0},{19, 108, 0},{22, 55, 0},
        {22, 69, 0},{22, 81, 0},{22, 95, 0},{25, 55, 0},{25, 64, 0},{25, 67, 0},
        {25, 70, 0},{25, 73, 0},{25, 77, 0},{25, 80, 0},{25, 83, 0},{25, 86, 0},
        {25, 95, 0},{28, 55, 0},{28, 64, 0},{28, 86, 0},{28, 95, 0},{30, 55, 0},
        {30, 58, 0},{30, 61, 0},{30, 64, 0},{30, 86, 0},{30, 89, 0},{30, 92, 0},
        {30, 95, 0},{32, 55, 0},{32, 64, 0},{32, 86, 0},{32, 95, 0},{35, 55, 0},
        {35, 64, 0},{35, 67, 0},{35, 70, 0},{35, 73, 0},{35, 77, 0},{35, 80, 0},
        {35, 83, 0},{35, 86, 0},{35, 95, 0},{39, 42, 0},{39, 45, 0},{39, 48, 0},
        {39, 51, 0},{39, 55, 0},{39, 58, 0},{39, 61, 0},{39, 64, 0},{39, 67, 0},
        {39, 70, 0},{39, 80, 0},{39, 83, 0},{39, 86, 0},{39, 89, 0},{39, 92, 0},
        {39, 95, 0},{39, 99, 0},{39, 102, 0},{39, 105, 0},{39, 108, 0},{42, 42, 0},
        {42, 55, 0},{42, 70, 0},{42, 80, 0},{42, 95, 0},{42, 108, 0},{45, 42, 0},
        {45, 45, 0},{45, 49, 0},{45, 55, 0},{45, 58, 0},{45, 61, 0},{45, 64, 0},
        {45, 67, 0},{45, 70, 0},{45, 73, 0},{45, 77, 0},{45, 80, 0},{45, 83, 0},
        {45, 86, 0},{45, 89, 0},{45, 92, 0},{45, 95, 0},{45, 101, 0},{45, 105, 0},
        {45, 108, 0},{48, 49, 0},{48, 55, 0},{48, 64, 0},{48, 86, 0},{48, 95, 0},
        {48, 101, 0},{51, 42, 0},{51, 45, 0},{51, 48, 0},{51, 52, 0},{51, 55, 0},
        {51, 64, 0},{51, 67, 0},{51, 70, 0},{51, 80, 0},{51, 83, 0},{51, 86, 0},
        {51, 95, 0},{51, 98, 0},{51, 102, 0},{51, 105, 0},{51, 108, 0},{53, 42, 0},
        {53, 70, 0},{53, 80, 0},{53, 108, 0},{55, 42, 0},{55, 45, 0},{55, 48, 0},
        {55, 51, 0},{55, 54, 0},{55, 57, 0},{55, 60, 0},{55, 63, 0},{55, 66, 0},
        {55, 69, 0},{55, 72, 0},{55, 75, 0},{55, 78, 0},{55, 81, 0},{55, 84, 0},
        {55, 87, 0},{55, 90, 0},{55, 93, 0},{55, 96, 0},{55, 99, 0},{55, 102, 0},
        {55, 105, 0},{55, 108, 0}};

    BufferElement *node;

    usleep(500);

    printCampo(livello);
    start = clock();
    //refresh();

    while(personaggi[PACMAN].vite > 0) {

        node = removeBuffer(buffer);

        if(node != NULL) {

            entita = node->posizione;

            //stampa solo se è un personaggio oppure un proiettile ancora in vita (motivo del controllo)
            if(!(entita.entita == BULLET && entita.sparo == false))
                printEntity(entita, mutexTerminale);
            //pulisce sempre la vecchia posizione
            clearEntity(entita, mutexTerminale, 3, pallini);

            //backup delle posizioni in locale
            if(entita.entita < NUM_PERSONAGGI)
                personaggi[entita.entita].posizione = entita;
            else
                for(int i = 0; i<NUM_PERSONAGGI ; i++)
                    for(int j = 0; j<MAX_PROIETTILI; j++)
                        if(proiettili[i][j].id == entita.id)
                            proiettili[i][j] = entita;
            
            score += checkScore(personaggi[PACMAN].posizione.x, personaggi[PACMAN].posizione.y, 3, pallini);

            
            //se un entità ha sparato
            if(entita.entita < NUM_PERSONAGGI && entita.sparo) {
                if(canShoot(proiettili, entita.entita)) {

                    if(entityMv(entita.x, entita.y, SU)) {
                        proiettili[entita.entita][SU-SHIFT_MOVIMENTO].x = entita.x+1;
                        proiettili[entita.entita][SU-SHIFT_MOVIMENTO].y = entita.y-1;
                        proiettili[entita.entita][SU-SHIFT_MOVIMENTO].dir = SU;
                        proiettili[entita.entita][SU-SHIFT_MOVIMENTO].sparo = true;
                        posPartenza.posizione = proiettili[entita.entita][SU-SHIFT_MOVIMENTO];

                        posPartenza.posizione = proiettili[entita.entita][SU-SHIFT_MOVIMENTO];
                        pthread_create(&(proiettili[entita.entita][SU-SHIFT_MOVIMENTO].id), NULL, &bullet, (void*)&posPartenza);
                    }
                    if(entityMv(entita.x, entita.y, GIU)) {
                        proiettili[entita.entita][GIU-SHIFT_MOVIMENTO].x = entita.x+1;
                        proiettili[entita.entita][GIU-SHIFT_MOVIMENTO].y = entita.y-3;
                        proiettili[entita.entita][GIU-SHIFT_MOVIMENTO].sparo = true;
                        proiettili[entita.entita][GIU-SHIFT_MOVIMENTO].dir = GIU;
                        posPartenza.posizione = proiettili[entita.entita][GIU-SHIFT_MOVIMENTO];

                        posPartenza.posizione = proiettili[entita.entita][GIU-SHIFT_MOVIMENTO];
                        pthread_create(&(proiettili[entita.entita][GIU-SHIFT_MOVIMENTO].id), NULL, &bullet, (void*)&posPartenza);
                    }
                    if(entityMv(entita.x, entita.y, DESTRA)) {
                        proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO].x = entita.x+3;
                        proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO].y = entita.y+1;
                        proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO].sparo = true;
                        proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO].dir = DESTRA;
                        posPartenza.posizione = proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO];

                        posPartenza.posizione = proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO];
                        pthread_create(&(proiettili[entita.entita][DESTRA-SHIFT_MOVIMENTO].id), NULL, &bullet, (void*)&posPartenza);
                    }
                    if(entityMv(entita.x, entita.y, SINISTRA)) {
                        proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO].x = entita.x-1;
                        proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO].y = entita.y+1;
                        proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO].sparo = true;
                        proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO].dir = SINISTRA;
                        posPartenza.posizione = proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO];

                        posPartenza.posizione = proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO];
                        pthread_create(&(proiettili[entita.entita][SINISTRA-SHIFT_MOVIMENTO].id), NULL, &bullet, (void*)&posPartenza);
                    }

                }
            }
            
        }
        printStats(livello, score);

        end = clock();
        deltaTime = ((double) (end-start))/CLOCKS_PER_SEC;
        mvprintw(3, 160, "Tempo: %f", deltaTime);

        if(entita.entita == PACMAN) {
            mvprintw(5, 160, "PACMAN [0]");
            mvprintw(6, 160, "X: %d  \t Y: %d  ", entita.x, entita.y);
            mvprintw(7, 160, "Sparo: %d, ID: %d", entita.sparo, entita.id);
        }
        
            mvprintw(9, 160, "BULLET [SU]");
            mvprintw(10, 160, "X: %d  \t Y: %d  ", proiettili[PACMAN][SU-SHIFT_MOVIMENTO].x, proiettili[PACMAN][SU-SHIFT_MOVIMENTO].y);
            mvprintw(11, 160, "Sparo: %d, ID: %d", proiettili[PACMAN][SU-SHIFT_MOVIMENTO].sparo, proiettili[PACMAN][SU-SHIFT_MOVIMENTO].id);
            if(entita.entita == BULLET && entita.dir == SU)
                mvprintw(9, 172, "SPARATO al ciclo %d", ciclo);

        
            mvprintw(13, 160, "BULLET [GIU]");
            mvprintw(14, 160, "X: %d  \t Y: %d  ", proiettili[PACMAN][GIU-SHIFT_MOVIMENTO].x, proiettili[PACMAN][GIU-SHIFT_MOVIMENTO].y);
            mvprintw(15, 160, "Sparo: %d, ID: %d", proiettili[PACMAN][GIU-SHIFT_MOVIMENTO].sparo, proiettili[PACMAN][GIU-SHIFT_MOVIMENTO].id);
            if(entita.entita == BULLET && entita.dir == GIU)
                mvprintw(13, 172, "SPARATO al ciclo %d", ciclo);

       
            mvprintw(17, 160, "BULLET [DESTRA]");
            mvprintw(18, 160, "X: %d  \t Y: %d  ", proiettili[PACMAN][DESTRA-SHIFT_MOVIMENTO].x, proiettili[PACMAN][DESTRA-SHIFT_MOVIMENTO].y);
            mvprintw(19, 160, "Sparo: %d, ID: %d", proiettili[PACMAN][DESTRA-SHIFT_MOVIMENTO].sparo, proiettili[PACMAN][DESTRA-SHIFT_MOVIMENTO].id);
            if(entita.entita == BULLET && entita.dir == DESTRA)
                mvprintw(17, 172, "SPARATO al ciclo %d", ciclo);

        
            mvprintw(21, 160, "BULLET [SINISTRA]");
            mvprintw(22, 160, "X: %d  \t Y: %d  ", proiettili[PACMAN][SINISTRA-SHIFT_MOVIMENTO].x, proiettili[PACMAN][SINISTRA-SHIFT_MOVIMENTO].y);
            mvprintw(23, 160, "Sparo: %d, ID: %d", proiettili[PACMAN][SINISTRA-SHIFT_MOVIMENTO].sparo, proiettili[PACMAN][SINISTRA-SHIFT_MOVIMENTO].id);
            if(entita.entita == BULLET && entita.dir == SINISTRA)
                mvprintw(21, 172, "SPARATO al ciclo %d", ciclo);

        if(entita.entita == BLINKY) {
            mvprintw(25, 160, "BLINKY [1]");
            mvprintw(26, 160, "X: %d  \t Y: %d  ", entita.x, entita.y);
            mvprintw(27, 160, "Sparo: %d, ID: %d", entita.sparo, entita.id);
        }

        ciclo++;

        /*
        if(node != NULL)
            mvprintw(29 + (ciclo % 47), 160, "%d : %s", ciclo, EntityName[node->posizione.entita]);
        else
            mvprintw(29 + (ciclo % 47), 160, "%d : NULL     ", ciclo);
        */

    }
}
