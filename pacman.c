#include "pacman.h"

void * pacman(void * param){
  Par * parametri = (Par*) param; /*Converto la mia variabile in input*/
  Pos * pos_pacman = parametri->posizione;
  pthread_mutex_t * mutex = parametri->mutex;
  int * num_vite = parametri->num_vite;

  pos_pacman->x=45;
  pos_pacman->y=29;

  pthread_mutex_lock(mutex);
  mvaddch(pos_pacman->y,pos_pacman->x,'@');
  refresh();
  pthread_mutex_unlock(mutex);

  while(*num_vite>0)
	{
		char c;
    c=getch();

    pthread_mutex_lock(mutex);
    mvaddch(pos_pacman->y,pos_pacman->x,' ');
    pthread_mutex_unlock(mutex);

    switch(c)// Mi sposto in base al tasto che ho premuto
		{				 // controllando ogni volta di non uscire dai limiti
		case SU:
			if(pacmanMv(pos_pacman->x, pos_pacman->y, SU))
			pos_pacman->y-=1;
      else
      pos_pacman->y = pos_pacman->y;
			break;

		case GIU:
			if(pacmanMv(pos_pacman->x, pos_pacman->y, GIU))
			pos_pacman->y+=1;
      else
      pos_pacman->y = pos_pacman->y;
			break;

		case SINISTRA:
			if(pacmanMv(pos_pacman->x, pos_pacman->y, SINISTRA))
			pos_pacman->x-=1;
      else
      pos_pacman->x= pos_pacman->x;
			break;

		case DESTRA:
			if(pacmanMv(pos_pacman->x, pos_pacman->y, DESTRA))
			pos_pacman->x+=1;
      else
      pos_pacman->x = pos_pacman->x;
			break;

		}

    pthread_mutex_lock(mutex);
    mvaddch(pos_pacman->y,pos_pacman->x,'@');
    refresh();
    pthread_mutex_unlock(mutex);
  }
}

_Bool pacmanMv(int x, int y, char dir) {
  char scampo[60][152]={"##==================================================================================================================================================##\n",
                       "||                                                                                                                                                  ||\n",
                       "||                                      #######################################################################                                     ||\n",
                       "||                                      #                              #########                              #                                     ||\n",
                       "||                                      # .  .  .  .   .  .  .  . .  . ######### .  . .  .  .  .   .  .  .  . #                                     ||\n",
                       "||         LEVEL:                       #                              #########                              #             LIVEs:                  ||\n",
                       "||         SCORE:                       #   ##########   ###########   #########   ###########   ##########   #             TIME:                   ||\n",
                       "||                                      # . ########## . ########### . ######### . ########### . ########## . #             FRUITs:                 ||\n",
                       "||                                      #   ##########   ###########   #########   ###########   ##########   #             KILLs:                  ||\n",
                       "||                                      #   ##########   ###########   #########   ###########   ##########   #                                     ||\n",
                       "||         HIGHSCORES:                  # . ########## . ########### . ######### . ########### . ########## . #                                     ||\n",
                       "||         1.                           #   ##########   ###########   #########   ###########   ##########   #                                     ||\n",
                       "||         2.                           #                                                                     #                                     ||\n",
                       "||         3.                           # .  .  .  .   .  .  .  . .  .  .  .  .  .  . .  .  .  .   .  .  .  . #                                     ||\n",
                       "||                                      #                                                                     #                                     ||\n",
                       "||                                      #   ##########   ######   ###################   ######   ##########   #                                     ||\n",
                       "||                                      # . ########## . ###### . ################### . ###### . ########## . #                                     ||\n",
                       "||                                      #   ##########   ######   ###################   ######   ##########   #                                     ||\n",
                       "||                                      #                ######        #########        ######                #                                     ||\n",
                       "||                                      # .  .  .   .  . ###### .    . ######### .    . ###### .  .   .  .  . #                                     ||\n",
                       "||                                      #                ######        #########        ######                #                                     ||\n",
                       "||                                      ##############   ###########   #########   ###########   ##############                                     ||\n",
                       "||                                      ############## . ########### . ######### . ########### . ##############                                     ||\n",
                       "||                                      ##############   ###########   #########   ###########   ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ############## . ###### .  .  .  .   .  .  .  . ###### . ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ##############   ######   #######+   +#######   ######   ##############                                     ||\n",
                       "||                                      ############## . ###### . #                 # . ###### . ##############                                     ||\n",
                       "||                                                                +                 +                                                               ||\n",
                       "||                                                     .  .  .  .                     .  .  .  .                                                    ||\n",
                       "||                                                                +                 +                                                               ||\n",
                       "||                                      ############## . ###### . #                 # . ###### . ##############                                     ||\n",
                       "||                                      ##############   ######   #######+   +#######   ######   ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ############## . ###### .  .  .  .   .  .  .  . ###### . ##############                                     ||\n",
                       "||                                      ##############   ######                         ######   ##############                                     ||\n",
                       "||                                      ##############   ######   ###################   ######   ##############                                     ||\n",
                       "||                                      #                               #######                               #                                     ||\n",
                       "||                                      # .  .  .  .   .  .  .  .  .  . ####### .  .  .  .  .  .   .  .  .  . #                                     ||\n",
                       "||                                      #                               #######                               #                                     ||\n",
                       "||                                      #   ##########   ############   #######   ############   ##########   #                                     ||\n",
                       "||                                      # . ########## . ############ . ####### . ############ . ########## . #                                     ||\n",
                       "||                                      #   ##########   ############   #######   ############   ##########   #                                     ||\n",
                       "||                                      #          ###                                           ###          #                                     ||\n",
                       "||                                      # .  .   . ### .  .  .  .  .  .  .   .  .  .  .  .  .  . ### .   .  . #                                     ||\n",
                       "||                                      #          ###                                           ###          #                                     ||\n",
                       "||                                      ########   ###   ######   ###################   ######   ###   ########                                     ||\n",
                       "||                                      ######## . ### . ###### . ################### . ###### . ### . ########                                     ||\n",
                       "||                                      ########   ###   ######   ###################   ######   ###   ########                                     ||\n",
                       "||                                      #                ######         #######         ######                #                                     ||\n",
                       "||                                      # .  .  .   .  . ###### .  .  . ####### .  .  . ###### .  .   .  .  . #                                     ||\n",
                       "||                                      #                ######         #######         ######                #                                     ||\n",
                       "||                                      # . ######################### . ####### . ######################### . #                                     ||\n",
                       "||                                      #                                                                     #                                     ||\n",
                       "||                                      # .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . #                                     ||\n",
                       "||                                      #                                                                     #                                     ||\n",
                       "||                                      #######################################################################                                     ||\n",
                       "||                                                                                                                                                  ||\n",
                       "##==================================================================================================================================================##"};

    switch (dir) {
        case SU:
            if(scampo[y-1][x] == '#' /*|| mvinch(x-1,y+1) == '#' || mvinch(x-1,y+2) == '#'*/)
                return false;
            break;
        case GIU:
            if(scampo[y+1][x] == '#' /*|| mvinch(x+4,y+1) == '#' || mvinch(x+4,y+2) == '#'*/)
                return false;
            break;
        case DESTRA:
            if(scampo[y][x+1] == '#' /*|| mvinch(x+1,y+4) == '#' || mvinch(x+2,y+4) == '#'*/)
                return false;
            break;
        case SINISTRA:
            if(scampo[y][x-1] == '#' /*|| mvinch(x+1,y-1) == '#' || mvinch(x+2,y-1) == '#'*/)
                return false;
            break;
        default:
            return false;
    }
    return true;
}